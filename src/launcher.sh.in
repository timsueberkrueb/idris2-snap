#!/usr/bin/env bash

IDRIS2_VERSION=

set -e

# Explicitly override SNAP. By default, Idris 2 generates Chez scheme code which gets
# compiled to Chez scheme byte code. Both the generated Chez scheme scripts as well as
# the generated Chez scheme byte code files start with a shebang pointing to the Chez scheme
# interpreter.
# For convenience, this snap package bundles a Chez scheme interpreter.
# Snap applications reside in /snap/idris2/<version number>, where <version number> is an
# integer. /snap/idris2/current is a symlink to the current version. By explicitly overriding
# SNAP we ensure that the shebang points to the "current" symlink rather than to the current
# explicit version number.
export SNAP="/snap/idris2/current"

# Update CHEZ to point to bundled scheme wrapper
export CHEZ="$SNAP/bin/chez"

# Discover Idris libraries in the home installation
DOT_IDRIS="$HOME/.idris2/$IDRIS2_VERSION"
if [ -d "$DOT_IDRIS" ]; then
    for new_path in $(find "$DOT_IDRIS" -mindepth 1 -maxdepth 1 -type d);
    do
        export IDRIS2_PATH="$new_path:$IDRIS2_PATH"
    done
fi

# Idris support in the home installation
export IDRIS2_DATA="$HOME/.idris2/$IDRIS2_VERSION/support:$IDRIS2_DATA"

# Discover Idris libraries bundled with the snap
for new_path in $(find "$SNAP/$IDRIS2_VERSION/" -mindepth 1 -maxdepth 1 -type d);
do
    export IDRIS2_PATH="$new_path:$IDRIS2_PATH"
done

# Idris support bundled with the snap
export IDRIS2_DATA="$SNAP/$IDRIS2_VERSION/support:$IDRIS2_DATA"

exec $@
