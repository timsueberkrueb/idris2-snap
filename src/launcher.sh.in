#!/usr/bin/env bash

IDRIS2_VERSION=

set -e

# Explicitly override SNAP. By default, Idris 2 generates Chez scheme code which gets
# compiled to Chez scheme byte code. Both the generated Chez scheme scripts as well as
# the generated Chez scheme byte code files start with a shebang pointing to the Chez scheme
# interpreter.
# For convenience, this snap package bundles a Chez scheme interpreter.
# Snap applications reside in /snap/idris2/<version number>, where <version number> is an
# integer. /snap/idris2/current is a symlink to the current version. By explicitly overriding
# SNAP we ensure that the shebang points to the "current" symlink rather than to the current
# explicit version number.
export SNAP="/snap/idris2/current"

# Update CHEZ to point to bundled scheme wrapper
export CHEZ="$SNAP/bin/chez"

# IDRIS2_PREFIX points to the ~/.idris2 folder in the home directory because
# the --install command uses this IDRIS2_PREFIX as the location for installing user libraries.
# The Idris installation (including the built-in libraries) that comes with the snap is read-only.
export IDRIS2_PREFIX="$HOME/.idris2"

# Path where user libraries for this specific Idris version will get installed to
DOT_IDRIS_USER_LIBS="$IDRIS2_PREFIX/$IDRIS2_VERSION"

# Create the ~/.idris2/<idris2-version> folder if it does not exist already.
# This is necessary because the Idris installation contained in the snap is read-only.
# User libraries will get installed to DOT_IDRIS_USER_LIBS.
if [ ! -d "$DOT_IDRIS_USER_LIBS" ]; then
    mkdir -p "$DOT_IDRIS_USER_LIBS"
fi

# Idris support in the home installation
export IDRIS2_DATA="$HOME/.idris2/$IDRIS2_VERSION/support:$IDRIS2_DATA"

# Discover Idris libraries bundled with the snap
for new_path in $(find "$SNAP/$IDRIS2_VERSION/" -mindepth 1 -maxdepth 1 -type d);
do
    export IDRIS2_PATH="$new_path:$IDRIS2_PATH"
done

# Idris support bundled with the snap
export IDRIS2_DATA="$SNAP/$IDRIS2_VERSION/support:$IDRIS2_DATA"
# Idris support libs required for chez codegen
export IDRIS2_LIBS="$SNAP/$IDRIS2_VERSION/lib:$IDRIS2_LIBS"

# Ensure Idris 2 finds the support library
export LD_LIBRARY_PATH=$SNAP/lib:$LD_LIBRARY_PATH

exec $SNAP/bin/chez --script $SNAP/bin/idris2_app/idris2.so $@
